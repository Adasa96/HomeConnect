{% extends 'base.html' %}

{% block title %}Pay with M-Pesa{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-body p-4">

        <h3 class="text-center mb-3">üí≥ Pay with M-Pesa</h3>
        <p class="text-muted text-center">Enter amount and phone number to receive a payment prompt.</p>

        <!-- Payment Form -->
        <form id="mpesa-form" method="post" action="{% url 'connectmpesa:start_payment' %}">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">Amount (KES)</label>
            <input class="form-control" name="amount" type="number" step="1" required placeholder="Enter amount">
          </div>

          <div class="mb-3">
            <label class="form-label">Phone Number (2547XXXXXXX)</label>
            <input class="form-control" name="phone" type="text" placeholder="2547XXXXXXXX" value="{{ user.phone|default:'' }}" required>
          </div>

          <div class="d-grid">
            <button class="btn btn-success py-2" type="submit">üí≥ Pay Now</button>
          </div>
        </form>

        <!-- Optional Payment Tips / Info -->
        <div class="alert alert-info mt-3">
          Ensure your phone is ready to receive the M-Pesa prompt. The transaction will appear on your phone.
        </div>

        <!-- MESSAGE BOX -->
        <div id="mpesa-result" class="alert mt-4 d-none"></div>

      </div>
    </div>

    <!-- Optional Back to Dashboard Button -->
    <div class="mt-3 text-center">
      <a href="{% url 'services:dashboard' %}" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
    </div>

  </div>
</div>

<script>
document.getElementById('mpesa-form').addEventListener('submit', async function(e) {
  e.preventDefault();

  const form = e.target;
  const data = new FormData(form);
  const box = document.getElementById('mpesa-result');

  box.classList.add('d-none');

  try {
    const resp = await fetch(form.action, {
      method: 'POST',
      body: data,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });

    const json = await resp.json();

    if (json.status === 'ok') {
      box.classList.remove('d-none', 'alert-danger');
      box.classList.add('alert', 'alert-success');
      box.innerHTML = `
        <strong>Payment Request Sent!</strong><br>
        Checkout ID: ${json.checkout_request_id}<br>
        You should receive an M-Pesa popup shortly.
      `;
    } else {
      box.classList.remove('d-none', 'alert-success');
      box.classList.add('alert', 'alert-danger');
      box.innerHTML = json.message || "Payment failed. Try again.";
    }

  } catch (error) {
    box.classList.remove('d-none', 'alert-success');
    box.classList.add('alert', 'alert-danger');
    box.innerHTML = "Network error ‚Äî please try again.";
  }
});
</script>

{% endblock %}
