{% extends 'base.html' %}

{% block title %}Pay with M-Pesa{% endblock %}

{% block content %}
<div class="row justify-content-center mt-4">
  <div class="col-md-6">
    <div class="card shadow-sm border-0 rounded-3">
      <div class="card-body p-4">

        <h3 class="text-center mb-3">üí≥ Pay with M-Pesa</h3>
        <p class="text-muted text-center">Enter amount and phone number to receive a payment prompt.</p>

        <!-- Payment Form -->
        <form id="mpesa-form" method="post" action="{% url 'connectmpesa:start_payment' %}">
          {% csrf_token %}

          <div class="mb-3">
            <label class="form-label">Amount (KES)</label>
            <input class="form-control" name="amount" type="number" step="1" required placeholder="Enter amount">
          </div>

          <div class="mb-3">
            <label class="form-label">Phone Number (2547XXXXXXX)</label>
            <input class="form-control" name="phone" type="text" placeholder="2547XXXXXXXX" value="{{ user.phone|default:'' }}" required>
          </div>

          <div class="d-grid">
            <button class="btn btn-success py-2" type="submit">üí≥ Pay Now</button>
          </div>
        </form>

        <div class="alert alert-info mt-3">
          Ensure your phone is ready to receive the M-Pesa prompt. The transaction will appear on your phone.
        </div>

        <!-- MESSAGE BOX -->
        <div id="mpesa-result" class="alert mt-4 d-none"></div>

      </div>
    </div>

    <div class="mt-3 text-center">
      <a href="{% url 'services:dashboard' %}" class="btn btn-outline-secondary">‚Üê Back to Dashboard</a>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('mpesa-form');
  const box = document.getElementById('mpesa-result');

  form.addEventListener('submit', async function(e) {
    e.preventDefault();

    const data = new FormData(form);
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    box.classList.add('d-none');
    box.innerHTML = '';

    try {
      const resp = await fetch(form.action, {
        method: 'POST',
        body: data,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': csrftoken
        }
      });

      const json = await resp.json();

      if (json.status === 'ok') {
        box.classList.remove('d-none', 'alert-danger');
        box.classList.add('alert', 'alert-info');
        box.innerHTML = "üì≤ Payment request sent! Waiting for confirmation...";

        // Start polling for payment result
        pollPaymentStatus(json.request_id);
      } else {
        box.classList.remove('d-none', 'alert-success');
        box.classList.add('alert', 'alert-danger');
        box.innerHTML = json.message || "Payment request failed.";
      }

    } catch (error) {
      box.classList.remove('d-none', 'alert-success');
      box.classList.add('alert', 'alert-danger');
      box.innerHTML = "Network error ‚Äî please try again.";
      console.error(error);
    }
  });

  // Polling function
  async function pollPaymentStatus(requestId) {
    let attempts = 0;
    const maxAttempts = 15; // poll ~30 seconds
    const interval = 2000;  // 2 seconds

    const timer = setInterval(async () => {
      attempts += 1;
      try {
        const resp = await fetch(`/connectmpesa/status/${requestId}/`);
        const data = await resp.json();

        if (data.payment_status === 'COMPLETED') {
          clearInterval(timer);
          box.classList.remove('alert-info', 'alert-danger');
          box.classList.add('alert', 'alert-success');
          box.innerHTML = "‚úÖ Payment completed successfully!";
        } else if (data.payment_status === 'FAILED') {
          clearInterval(timer);
          box.classList.remove('alert-info', 'alert-success');
          box.classList.add('alert', 'alert-danger');
          box.innerHTML = "‚ùå Payment failed. Please try again.";
        } else if (attempts >= maxAttempts) {
          clearInterval(timer);
          box.classList.remove('alert-info');
          box.classList.add('alert', 'alert-warning');
          box.innerHTML = "‚è≥ Payment pending. Check your M-Pesa or try again later.";
        }
      } catch (err) {
        clearInterval(timer);
        box.classList.remove('alert-info', 'alert-success');
        box.classList.add('alert', 'alert-danger');
        box.innerHTML = "‚ö†Ô∏è Error checking payment status.";
        console.error(err);
      }
    }, interval);
  }
});
</script>
{% endblock %}
